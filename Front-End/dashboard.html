<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard â€” FileVault</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
body{background: linear-gradient(180deg,#071029,#0b1530); color:#eef2f6; min-height:100vh;}
.panel{background: rgba(255,255,255,0.03); border-radius:12px; padding:18px; margin-top:18px;}
.uploader{border:2px dashed rgba(255,255,255,0.04); padding:26px; border-radius:10px; text-align:center; cursor:pointer;}
.uploader.dragover{border-color:#7c3aed; transform:translateY(-3px);}
.muted{color:#b8c4d3;}
.file-card{background: rgba(0,0,0,0.2); padding:8px; border-radius:8px;}
</style>
</head>
<body>
<nav class="navbar navbar-dark">
  <div class="container">
    <a class="navbar-brand" href="index.html">FileVault</a>
  </div>
</nav>

<main class="container">
  <div class="row">
    <div class="col-lg-8">
      <div class="panel">
        <h5>Upload files</h5>
        <div id="uploader" class="uploader my-3">
          <p id="uploaderMsg">Drag & drop files here or choose files</p>
          <input id="fileInput" type="file" multiple class="form-control" style="cursor:pointer;">
          <div id="progress" class="muted small mt-2"></div>
        </div>
        <div id="fileList" class="mt-3"></div>
      </div>
    </div>
  </div>
</main>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// Supabase config
const SUPABASE_URL = 'https://laxgelzpqmohldjatwux.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxheGdlbHpwcW1vaGxkamF0d3V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDE2NzAsImV4cCI6MjA4MDA3NzY3MH0.jcmBW_oTUjcwYgsbrUdYjwbTYQlrgIPKM1s2EPc_OvU'; // replace with your anon key
const BUCKET = 'uploads';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const fileInput = document.getElementById('fileInput');
const uploader = document.getElementById('uploader');
const uploaderMsg = document.getElementById('uploaderMsg');
const progress = document.getElementById('progress');
const fileList = document.getElementById('fileList');

// Drag & drop UI
['dragenter','dragover'].forEach(e => uploader.addEventListener(e, ev => { 
  ev.preventDefault(); uploader.classList.add('dragover'); uploaderMsg.textContent='Drop files to upload'; 
}));
['dragleave','drop'].forEach(e => uploader.addEventListener(e, ev => { 
  ev.preventDefault(); uploader.classList.remove('dragover'); uploaderMsg.textContent='Drag & drop files here or choose files'; 
}));

uploader.addEventListener('drop', ev => handleFiles(Array.from(ev.dataTransfer.files)));
fileInput.addEventListener('change', ev => { handleFiles(Array.from(ev.target.files)); fileInput.value=''; });

// sanitize filename
function sanitizeFilename(name){
  return name.replace(/[^a-zA-Z0-9.\-_]/g,'_');
}

// handle multiple files
async function handleFiles(files){
  const uid = 'default_user';
  for(const file of files) await uploadFile(uid, file);
  await loadFiles(uid);
}

// upload file
async function uploadFile(uid, file){
  const path = `${uid}/${Date.now()}_${sanitizeFilename(file.name)}`;
  progress.textContent = `Uploading ${file.name}...`;
  const { error } = await supabase.storage.from(BUCKET).upload(path, file, { upsert: false });
  if(error){ alert('Upload error: '+error.message); progress.textContent=''; return; }
  progress.textContent = `Uploaded ${file.name}`;
  setTimeout(()=>progress.textContent='', 1500);
}

// load files list
async function loadFiles(uid){
  fileList.innerHTML = '<div class="muted">Loading files...</div>';
  const { data, error } = await supabase.storage.from(BUCKET).list(uid, { limit: 200, sortBy: { column: 'name', order: 'desc' } });
  if(error){ fileList.innerHTML='<div class="text-danger small">Failed to list files</div>'; return; }
  if(!data || data.length===0){ fileList.innerHTML='<div class="muted">No files yet</div>'; return; }

  fileList.innerHTML='';
  for(const item of data){
    const row = document.createElement('div'); 
    row.className='d-flex align-items-center justify-content-between mb-2 file-card';

    const left = document.createElement('div');
    left.innerHTML = `<div><strong>${item.name}</strong></div>
                      <div class="muted small">${item.size ? (item.size/1024).toFixed(1)+' KB' : ''}</div>`;

    const right = document.createElement('div');
    const openUrl = `https://bdqrcfadxjvlgxibiiwl.supabase.co/storage/v1/object/public/${BUCKET}/${uid}/${item.name}`;
    right.innerHTML = `<a class="btn btn-sm btn-light me-1" href="${openUrl}" target="_blank">Open</a>
                       <button class="btn btn-sm btn-outline-light" data-name="${item.name}">Delete</button>`;

    right.querySelector('button').addEventListener('click', async ()=>{
      if(!confirm('Delete file?')) return;
      const { error } = await supabase.storage.from(BUCKET).remove([`${uid}/${item.name}`]);
      if(error){ alert('Delete failed: '+error.message); return; }
      loadFiles(uid);
    });

    row.appendChild(left);
    row.appendChild(right);
    fileList.appendChild(row);
  }
}

// initialize
loadFiles('default_user');
</script>
</body>
</html>
