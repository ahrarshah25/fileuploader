<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard — FileVault</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    body{background: linear-gradient(180deg,#071029,#0b1530); color:#eef2f6; min-height:100vh}
    .panel{background: rgba(255,255,255,0.03); border-radius:12px; padding:18px; margin-top:18px}
    .uploader{border:2px dashed rgba(255,255,255,0.04); padding:26px; border-radius:10px; text-align:center}
    .uploader.dragover{border-color:#7c3aed; transform:translateY(-3px)}
    .muted{color:#b8c4d3}
    .file-card{background: rgba(0,0,0,0.2); padding:8px; border-radius:8px}
  </style>
</head>
<body>
  <nav class="navbar navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">FileVault</a>
      <div>
        <span id="userEmail" class="me-3 muted"></span>
        <button id="signOut" class="btn btn-outline-light btn-sm">Sign Out</button>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="row">
      <div class="col-lg-8">
        <div class="panel">
          <h5>Upload files</h5>
          <div id="uploader" class="uploader my-3">
            <p id="uploaderMsg">Drag & drop files here or choose files</p>
            <input id="fileInput" type="file" multiple class="form-control" />
            <div id="progress" class="muted small mt-2"></div>
          </div>

          <div id="fileList" class="mt-3">
            <!-- file items -->
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="panel">
          <h6>Profile</h6>
          <div id="profileInfo">
            <div class="muted">Not signed in</div>
          </div>
        </div>

        <div class="panel mt-3">
          <h6>Storage</h6>
          <div class="muted">Bucket: <strong>user-uploads</strong></div>
          <div class="muted small mt-2">Files are stored as: <code>user_id/filename</code></div>
        </div>
      </div>
    </div>
  </main>

<script type="module">
  // Replace these with your Supabase values:
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
  const SUPABASE_URL = 'https://bdqrcfadxjvlgxibiiwl.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkcXJjZmFkeGp2bGd4aWJpaXdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MTIwNDcsImV4cCI6MjA4MDA4ODA0N30.BQ8UJM2pmL_9yk62D8d5qL4tYVSHe1YeXCfgRuCcva8';
  const BUCKET = 'user-uploads';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const fileInput = document.getElementById('fileInput');
  const uploader = document.getElementById('uploader');
  const uploaderMsg = document.getElementById('uploaderMsg');
  const progress = document.getElementById('progress');
  const fileList = document.getElementById('fileList');
  const userEmail = document.getElementById('userEmail');
  const signOut = document.getElementById('signOut');
  const profileInfo = document.getElementById('profileInfo');

  // Redirect to login if not signed in
  async function checkAuth(){
    const { data } = await supabase.auth.getSession();
    const user = data?.session?.user || null;
    if (!user) {
      window.location.href = 'login.html';
      return null;
    }
    // show user info and load files
    userEmail.textContent = user.email;
    profileInfo.innerHTML = `<div><strong>${user.user_metadata?.full_name || user.email}</strong></div>
                             <div class="muted small">${user.id}</div>`;
    loadFiles(user.id);
    return user;
  }

  // sign out
  signOut.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
  });

  // drag & drop styling
  ['dragenter','dragover'].forEach(e => uploader.addEventListener(e, (ev)=>{ev.preventDefault(); uploader.classList.add('dragover'); uploaderMsg.textContent='Drop files to upload'}));
  ['dragleave','drop'].forEach(e => uploader.addEventListener(e, (ev)=>{ev.preventDefault(); uploader.classList.remove('dragover'); uploaderMsg.textContent='Drag & drop files here or choose files'}));
  uploader.addEventListener('drop', (ev) => {
    const files = Array.from(ev.dataTransfer.files);
    handleFiles(files);
  });

  fileInput.addEventListener('change', (ev) => {
    const files = Array.from(ev.target.files);
    handleFiles(files);
    fileInput.value = '';
  });

  async function handleFiles(files){
    const { data } = await supabase.auth.getSession();
    const user = data?.session?.user;
    if (!user) { alert('Please login'); window.location.href='login.html'; return; }
    for (const f of files) {
      await uploadFile(user.id, f);
    }
    await loadFiles(user.id);
  }

  function sanitizeFilename(name){ return name.replace(/[^a-zA-Z0-9.\-_ ]/g, ''); }

  async function uploadFile(uid, file) {
    const maxMB = 100;
    if (file.size > maxMB * 1024 * 1024) { alert('File too large'); return; }
    const path = `${uid}/${Date.now()}_${sanitizeFilename(file.name)}`;
    progress.textContent = `Uploading ${file.name}...`;
    const { data, error } = await supabase.storage.from(BUCKET).upload(path, file);
    if (error) { alert('Upload error: '+error.message); progress.textContent=''; return; }

    // optional: insert metadata into files table (if you created it)
    await supabase.from('files').insert([{
      user_id: uid, path: path, name: file.name, size: file.size, content_type: file.type
    }]);

    progress.textContent = `Uploaded ${file.name}`;
    setTimeout(()=> progress.textContent = '', 1500);
  }

  async function loadFiles(uid) {
    fileList.innerHTML = '<div class="muted">Loading files...</div>';
    const { data, error } = await supabase.storage.from(BUCKET).list(uid, { limit: 200, sortBy: { column: 'name', order: 'desc' } });
    if (error) { fileList.innerHTML = '<div class="text-danger small">Failed to list files</div>'; return; }
    if (!data || data.length === 0) { fileList.innerHTML = '<div class="muted">No files yet</div>'; return; }

    fileList.innerHTML = '';
    for (const item of data) {
      const row = document.createElement('div');
      row.className = 'd-flex align-items-center justify-content-between mb-2 file-card';
      const left = document.createElement('div');
      left.innerHTML = `<div><strong>${item.name}</strong></div><div class="muted small">${(item.size ? (item.size/1024).toFixed(1)+' KB' : '')} • ${new Date(item.updated_at).toLocaleString()}</div>`;
      const right = document.createElement('div');

      // create signed url (1 hour)
      const { data: urlData, error: urlErr } = await supabase.storage.from(BUCKET).createSignedUrl(`${uid}/${item.name}`, 60*60);
      const openUrl = urlData?.signedUrl || '#';

      right.innerHTML = `<a class="btn btn-sm btn-light me-1" href="${openUrl}" target="_blank">Open</a>
                         <button class="btn btn-sm btn-outline-light" data-name="${item.name}">Delete</button>`;
      const delBtn = right.querySelector('button');
      delBtn.addEventListener('click', async () => {
        if (!confirm('Delete file?')) return;
        const { error } = await supabase.storage.from(BUCKET).remove([`${uid}/${item.name}`]);
        if (error) { alert('Delete failed: '+error.message); return; }
        // delete from files table as well (optional)
        await supabase.from('files').delete().eq('path', `${uid}/${item.name}`);
        loadFiles(uid);
      });

      row.appendChild(left);
      row.appendChild(right);
      fileList.appendChild(row);
    }
  }

  // init
  (async ()=>{ await checkAuth(); })();
</script>
</body>
</html>
